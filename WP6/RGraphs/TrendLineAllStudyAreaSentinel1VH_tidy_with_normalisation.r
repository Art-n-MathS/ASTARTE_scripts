
# Rscript "/home/milto/Documents/ASTARTE/Scripts/WP6/RGraphs/TrendLineAllStudyAreaSentinel1VH_tidy_with_normalisation.r"


# c-band data for entire study area filtered
Af<-c(-11.6496397270891,-11.388527341566,-11.1626211611812,-10.7709142055273,-10.4702081190412,-10.297278510782,-10.1690081784866,-10.3108921815994,-10.4585927612367,-10.6469050375461,-10.8954263888282,-11.3433629573715,-11.5629486389943,-12.176806242299,-11.3875939551695,-11.412660912257,-11.0148345117958,-10.5920282009116,-10.4080223909864,-10.5102313930756,-10.7545750593137,-10.836326037146,-10.9514240458166,-10.79074830457,-11.0437794299733,-11.3831906257456,-11.3219999328164,-11.1914712459036,-10.8716920150463,-10.5824866516703,-10.3750507977272,-10.5146818625503,-10.648118778215,-10.8260973882162,-10.8561668190584,-10.7594025741754,-10.6735535503422,-10.9371578153411,-10.8932755194734,-10.947252223265,-10.7979006293638,-10.7266496443522,-10.5355030905843,-10.4944902880017,-10.6386455498984,-10.7151306131783,-10.8695360729576,-10.6593247178208,-10.7993114715929,-10.8706502058605,-11.1163068930441,-11.0823111917478,-10.8966812119788,-10.7488579748798,-10.652236954551,-10.7105578510892,-10.8731284291486,-10.9211600178523,-10.8993200377925,-10.8163121268858,-10.7993240917353,-10.9158597742678,-10.9352007042387,-11.0525225277176,-10.821631630293,-10.6506113015956,-10.4648729854706,-10.499520744261,-10.5770915287971,-10.7755613840533,-10.9273970876162,-11.0440249800324) 
# c-band data for entire study area filtered
A<-c(-11.8839818665544,-11.3558385707335,-11.254312161456,-10.7165536473514,-10.3968146627144,-10.2935563631455,-9.98707726975831,-10.3216664382143,-10.4783742578554,-10.5762481315342,-10.8499611784531,-11.3270343505167,-11.3604103732633,-13.1611581503915,-10.7665752480822,-11.5737204120313,-11.2215084754322,-10.3722828774767,-10.1903814618587,-10.4731408594664,-10.8416239713654,-10.8476378161834,-11.173218070413,-10.4472606056287,-10.9463593123311,-11.7186234393964,-11.34221112523,-11.262145391818,-10.9028354676566,-10.5160659747652,-10.1446575162199,-10.5363126118815,-10.6250718344569,-10.9027820031965,-11.0041475854632,-10.7017251876931,-10.4150300996847,-11.1613423904543,-10.8621792642395,-11.0216955258252,-10.7651247159998,-10.820903173295,-10.4366825938873,-10.3690665468568,-10.6608773673843,-10.703461079042,-11.1167445487895,-10.436490504683,-10.7931850479193,-10.7696333132921,-11.3036351868597,-11.1998716163323,-10.8416766882024,-10.728247539564,-10.5502409158795,-10.6331036366773,-10.9610189186494,-10.9773051843848,-10.9403690798834,-10.7542094741763,-10.7255777384373,-10.9612898565456,-10.8670549288722,-11.2831033431448,-10.8057147398128,-10.6248210798265,-10.3423873498234,-10.4791016177709,-10.5105915916996,-10.7888602616332,-10.9832376867362,-11.1068148641976) 
# choosing to use filtered data, comment if you want to use the raw data
# c-band data for entire study area non-filtered
A_VH_N<-c(0.1638784254489709,0.18946871297211065,0.1485525153143707,0.0,0.24371560023156164,0.2978977522484425,0.5848862685070864,0.755523114571315,0.8106295339164451,0.9741899015694453,0.7956278769936399,0.7119967610460165,0.6597638776032658,0.5136899444984395,0.2590877053776156,0.2412757414654882,0.0,0.558190968296887,0.12743741083297572,0.3154042741033026,0.7686151260632577,0.8656914456459657,0.7147896972790069,0.5181393072310827,0.5149298658999971,0.3411756776654409,0.7286013533559579,0.46224462715593184,0.050106222698948266,0.25098823332402176,0.2937173495209675,0.48547223448783966,0.6918816171153056,0.8900931928470064,0.6810764839694183,0.6337078660432145,0.4855007671575218,0.4314044445677377,0.592799853367421,0.7458019830745588,0.3475134364949424,0.5071694520851917,0.4220395396228538,0.5589650816566819,0.5291974884369074,0.7342465785175011,0.7703316027497306,0.6145993321954357,0.5918734507730489,0.371314209652441,0.734349091809772,0.5439899714313895,0.5565589539740833,0.271575264539336,0.32695133458994097,0.5181111735494802,0.5786455253345191,0.673643290084881,0.6294214903900963,0.4544211551775796,0.4457295750050497,0.4654414671446987,0.5647902782335382,0.5800703326484883,0.454276562274251,0.5045674295750916,0.28253260544466224,0.5373031824891585,0.633841687633053,0.7845696351950779,0.7116085869167773,0.6948031609536571,0.5462980036927708,0.4425635441512491,0.3766134385315841) 
# choosing to use filtered data, comment if you want to use the raw data
A_VH<-c(-11.505437310923842,-11.457486280780348,-11.53415497101954,-11.883981866554372,-11.355838570733457,-11.254312161456049,-10.716553647351379,-10.396814662714418,-10.293556363145528,-9.987077269758315,-10.321666438214335,-10.478374257855375,-10.576248131534214,-10.849961178453075,-11.327034350516671,-11.360410373263306,-13.161158150391486,-10.76657524808218,-11.573720412031285,-11.22150847543216,-10.3722828774767,-10.190381461858733,-10.473140859466401,-10.841623971365449,-10.84763781618339,-11.173218070413036,-10.447260605628745,-10.946359312331078,-11.718623439396412,-11.34221112523001,-11.262145391817992,-10.902835467656553,-10.516065974765162,-10.144657516219866,-10.536312611881467,-10.625071834456875,-10.90278200319654,-11.004147585463224,-10.701725187693086,-10.415030099684726,-11.161342390454347,-10.862179264239542,-11.021695525825248,-10.765124715999786,-10.82090317329496,-10.436682593887252,-10.369066546856763,-10.66087736738433,-10.703461079042004,-11.116744548789548,-10.436490504682965,-10.793185047919302,-10.76963331329214,-11.303635186859722,-11.199871616332281,-10.841676688202387,-10.728247539564,-10.55024091587952,-10.633103636677275,-10.961018918649355,-10.977305184384772,-10.940369079883448,-10.75420947417626,-10.725577738437341,-10.961289856545609,-10.86705492887219,-11.283103343144846,-10.805714739812844,-10.624821079826534,-10.342387349823374,-10.479101617770938,-10.510591591699647,-10.788860261633193,-10.983237686736242,-11.106814864197638)
A_VV_N<-c(0.2871040109132067,0.24008648214555717,0.47548837028161334,0.621736143993646,0.5787343855063932,0.5593901879446622,0.7367588659068602,0.9601409663149323,0.98211120527632,1.080078476714418,1.0151050664944732,0.8940564642699378,0.8912324012612269,0.7494721471383627,0.3316933309299893,0.5527580581670775,0.0,0.5393557694902007,0.0,0.059575008404036456,0.6396236371979112,0.6441907695092758,0.5271446276943365,0.3676844976119126,0.3479325064114247,0.12187409108138908,0.8093857428747971,0.718122593300862,0.11752192170909387,0.380874544517941,0.06553370145034254,0.38313979178630075,0.5820111874077181,0.7342910245067018,0.550462562564368,0.53648993304606,0.45059545462368633,0.5442608961482278,0.693650803189617,0.8592979708975627,0.4440236686826895,0.4042980672320748,0.29078092608448436,0.3800084243805651,0.43286230860707764,0.536083580393872,0.5851259664196363,0.3995256987079464,0.4955595881429797,0.2779497958307785,0.7739830570586672,0.7166613037017515,0.6277877718820618,0.4129468318447309,0.26605522501448564,0.383058920857107,0.4692794540562877,0.5232809086623624,0.5022629073557706,0.33548630807104163,0.3346063887594263,0.3679609252765482,0.5599453431054459,0.626970729125215,0.5153370461657355,0.44251897969129395,0.18128049344253783,0.4167459708182022,0.5371721695074498,0.6521621341251324,0.5907135374312795,0.5731310057528599,0.4721033528624179,0.40283666886985864,0.5197667245048119)
A_VV<-c(-4.641377437950861,-4.712477974211646,-4.356500088474889,-4.135342247762808,-4.20037008246058,-4.229622636906189,-3.9614033482808826,-3.6236019464130202,-3.5903782570172673,-3.4422308380051616,-3.540484498510361,-3.7235358148463393,-3.7278064007239142,-3.942178154254608,-4.573948871461029,-4.239651832316856,-5.6819251712157195,-4.259918952623345,-5.345085885005469,-4.985449840676002,-4.1082925411423385,-4.1013860625369505,-4.278384804674673,-4.51952254751742,-4.549391772961257,-4.89124033407253,-3.8515760129293195,-3.98958536913393,-4.8978217428445046,-4.499576382057342,-4.976439025303304,-4.496150844821227,-4.195414858770371,-3.965135251074518,-4.243123111489002,-4.264252708849051,-4.394143488686746,-4.2525013544433925,-4.026591937657967,-3.7760980737137864,-4.4040814313401135,-4.464155017520686,-4.635817157618919,-4.5008861405207865,-4.420959789424338,-4.264867200768104,-4.190704648261953,-4.471371857073791,-4.326148124202107,-4.6552205645138,-3.9051124282317518,-3.991795150822851,-4.12619089507808,-4.451076239922824,-4.673207693692997,-4.496273138922689,-4.365889294687758,-4.284227572304846,-4.316011275174759,-4.568213080665081,-4.569543706424492,-4.519104529903393,-4.228783123842142,-4.127426438069863,-4.296240387488802,-4.406356842170883,-4.801405177357363,-4.445331131121425,-4.263221021741437,-4.089331658280221,-4.1822550485969785,-4.208843588316617,-4.361618957119523,-4.466364963682631,-4.289541768619921)

A=A_VV_N

x = c(1:length(A))  


# Divide data according to years
A2015<-A[1 :12]
A2016<-A[13:24]
A2017<-A[25:36]
A2018<-A[37:48]
A2019<-A[49:60]
A2020<-A[61:72]

# Calculate mean value for each year
m_A15=mean(A2015)
m_A16=mean(A2016)
m_A17=mean(A2017)
m_A18=mean(A2018)
m_A19=mean(A2019)
m_A20=mean(A2020)

# Calculate std for each year
sd_A15=sd(A2015)
sd_A16=sd(A2016)
sd_A17=sd(A2017)
sd_A18=sd(A2018)
sd_A19=sd(A2019)
sd_A20=sd(A2020)

# manual definition of peak coordinates
peaks<-c(A2015[10],A2016[10],A2017[10],A2018[11],A2019[10],A2020[10])
xpeaks<-c(10      ,10+12    ,10+12*2  ,11+12*3  ,10+12*4  ,10+12*5  )


#group means and stds into arrays for easy interpretation
sds<-c(sd_A15,sd_A16,sd_A17,sd_A18,sd_A19,sd_A20)
means<-c(m_A15,m_A16,m_A17,m_A18,m_A19,m_A20)
# means=-10.79695 -11.03318 -10.86451 -10.74070 -10.86557 -10.78863
# stds= 0.4902407 0.5133871 0.3188508 0.1506143 0.1365497 0.2012161

# these are for drawing the polygon, L represent the lower value of STD on the graph and H the higher
sds_L<-means-sds/2
sds_H<-means+sds/2

# these are the corresponsing Julies were the std will be drawn on
sds_X<-c(7      ,7+12    ,7+12*2  ,7+12*3  ,7+12*4  ,7+12*5  )
xm<-sds_X
ym<-c(m_A15,m_A16,m_A17,m_A18,m_A19,m_A20)

# calculate linear regression of the standard deviation 
sds14<-c(sd_A15,sd_A16,sd_A17,sd_A18)
sds_X14<-c(7      ,7+12    ,7+12*2  ,7+12*3)
#regSds = lm(sds14~sds_X14)
regAll = lm(means~xm)
# calculate linear regression of all points of backscattered coefficient included on the graph
reg = lm(means[1:4]~xm[1:4])
# calculate linear regression of peak blooming backscattered coefficients on the graph
regPeaks = lm(peaks[1:4]~xpeaks[1:4])
regPeaksAll = lm(peaks~xpeaks)

# Means
regMeansAllL=lm(means~xm)
regMeansAll = as.numeric(coef(summary(lm(means~xm)))[, "Estimate"])
re58=regMeansAll[2]*58+regMeansAll[1]
tmp= (re58-means[5])*(re58-means[5])
rsme58=sqrt(tmp)
rrsme58=rsme58/means[5]*100.0
re70=regMeansAll[2]*70+regMeansAll[1]
rsme70=sqrt((re70-means[6])*(re70-means[6]))
rrsme70=rsme70/means[6]*100.0
regMeansAll<-c(regMeansAll[2], regMeansAll[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regMeans14L=lm(means[1:4]~xm[1:4])
regMeans14 = as.numeric(coef(summary(lm(means[1:4]~xm[1:4])))[, "Estimate"])
re58=regMeans14[2]*58+regMeans14[1]
rsme58=sqrt((re58-means[5])*(re58-means[5]))
rrsme58=rsme58/means[5]*100.0
re70=regMeans14[2]*70+regMeans14[1]
rsme70=sqrt((re70-means[6])*(re70-means[6]))
rrsme70=rsme70/means[6]*100.0
regMeans14<-c(regMeans14[2], regMeans14[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regMeans24L=lm(means[2:4]~xm[2:4])
regMeans24 = as.numeric(coef(summary(lm(means[2:4]~xm[2:4])))[, "Estimate"])
re58=regMeans24[2]*58+regMeans24[1]
rsme58=sqrt((re58-means[5])*(re58-means[5]))
rrsme58=rsme58/means[5]*100.0
re70=regMeans24[2]*70+regMeans24[1]
rsme70=sqrt((re70-means[6])*(re70-means[6]))
rrsme70=rsme70/means[6]*100.0
regMeans24<-c(regMeans24[2], regMeans24[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)
print("Hello")

regMeans15L=lm(means[1:5]~xm[1:5])
regMeans15 = as.numeric(coef(summary(lm(means[1:5]~xm[1:5])))[, "Estimate"])
re58=regMeans15[2]*58+regMeans15[1]
rsme58=sqrt((re58-means[5])*(re58-means[5]))
rrsme58=rsme58/means[5]*100.0
re70=regMeans15[2]*70+regMeans15[1]
rsme70=sqrt((re70-means[6])*(re70-means[6]))
rrsme70=rsme70/means[6]*100.0
regMeans15<-c(regMeans15[2], regMeans15[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regMeans25L=lm(means[2:5]~xm[2:5])
regMeans25 = as.numeric(coef(summary(lm(means[2:5]~xm[2:5])))[, "Estimate"])
re58=regMeans25[2]*58+regMeans25[1]
rsme58=sqrt((re58-means[5])*(re58-means[5]))
rrsme58=rsme58/means[5]*100.0
re70=regMeans25[2]*70+regMeans25[1]
rsme70=sqrt((re70-means[6])*(re70-means[6]))
rrsme70=rsme70/means[6]*100.0
regMeans25<-c(regMeans25[2], regMeans25[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

# Peaks
regPeaksAllL=lm(peaks~xpeaks)
regPeaksAll = as.numeric(coef(summary(lm(peaks~xpeaks)))[, "Estimate"])
re58=regPeaksAll[2]*58+regPeaksAll[1]
rsme58=sqrt((re58-peaks[5])*(re58-peaks[5]))
rrsme58=rsme58/peaks[5]*100.0
re70=regPeaksAll[2]*70+regPeaksAll[1]
rsme70=sqrt((re70-peaks[6])*(re70-peaks[6]))
rrsme70=rsme70/peaks[5]*100.0
regPeaksAll<-c(regPeaksAll[2], regPeaksAll[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regPeaks14L= lm(peaks[1:4]~xpeaks[1:4])
regPeaks14 = as.numeric(coef(summary(lm(peaks[1:4]~xpeaks[1:4])))[, "Estimate"])
re58=regPeaks14[2]*58+regPeaks14[1]
rsme58=sqrt((re58-peaks[5])*(re58-peaks[5]))
rrsme58=rsme58/peaks[5]*100.0
re70=regPeaks14[2]*70+regPeaks14[1]
rrsme70=rsme70/peaks[6]*100.0
rsme70=sqrt((re70-peaks[6])*(re70-peaks[6]))
regPeaks14<-c(regPeaks14[2], regPeaks14[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regPeaks24L=lm(peaks[2:4]~xpeaks[2:4])
regPeaks24 = as.numeric(coef(summary(lm(peaks[2:4]~xpeaks[2:4])))[, "Estimate"])
re58=regPeaks24[2]*58+regPeaks24[1]
rsme58=sqrt((re58-peaks[5])*(re58-peaks[5]))
rrsme58=rsme58/peaks[5]*100.0
re70=regPeaks24[2]*70+regPeaks24[1]
rrsme70=rsme70/peaks[6]*100.0
rsme70=sqrt((re70-peaks[6])*(re70-peaks[6]))
regPeaks24<-c(regPeaks24[2], regPeaks24[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regPeaks15L=lm(peaks[1:5]~xpeaks[1:5])
regPeaks15 = as.numeric(coef(summary(lm(peaks[1:5]~xpeaks[1:5])))[, "Estimate"])
re58=regPeaks15[2]*58+regPeaks15[1]
rsme58=sqrt((re58-peaks[5])*(re58-peaks[5]))
rrsme58=rsme58/peaks[5]*100.0
re70=regPeaks15[2]*70+regPeaks15[1]
rrsme70=rsme70/peaks[6]*100.0
rsme70=sqrt((re70-peaks[6])*(re70-peaks[6]))
regPeaks15<-c(regPeaks15[2], regPeaks15[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)

regPeaks25L=lm(peaks[2:5]~xpeaks[2:5])
regPeaks25 = as.numeric(coef(summary(lm(peaks[2:5]~xpeaks[2:5])))[, "Estimate"])
re58=regPeaks25[2]*58+regPeaks25[1]
rsme58=sqrt((re58-peaks[5])*(re58-peaks[5]))
rrsme58=rsme58/peaks[5]*100.0
re70=regPeaks25[2]*70+regPeaks25[1]
rrsme70=rsme70/peaks[6]*100.0
rsme70=sqrt((re70-peaks[6])*(re70-peaks[6]))
regPeaks25<-c(regPeaks25[2], regPeaks25[1], re58,rsme58,rrsme58, re70,rsme70,rrsme70)


mydataMeans<-data.frame(regMeansAll,regMeans14,regMeans24,regMeans15,regMeans25)
mydataPeaks<-data.frame(regPeaksAll,regPeaks14,regPeaks24,regPeaks15,regPeaks25)

write.csv(mydataMeans,"mydataMeansVV.csv")
write.csv(mydataPeaks,"mydataPeaksVV.csv")

print("Means regMeansAll[2], regMeansAll[1], re58, re70,rsme58,rsme70")
print(regMeansAll)
print(regMeans14)
print(regMeans24)
print(regMeans15)
print(regMeans25)

print("Peaks regPeaksAll[2], regPeaksAll[1], re58, re70,rsme58,rsme70")
print(regPeaksAll)
print(regPeaks14)
print(regPeaks24)
print(regPeaks15)
print(regPeaks25)



# define name and size of image to be exported
png(filename="SARphenology1normalisedVV.png", width = 2000, height = 1100)


# plot backscattered coefficient as points - used to start the plot, points drawn again later
plot(x, A,ylab="Backscattered Coefficient (DB)", lwd=2,cex.lab=3,cex.axis=2.5)
# it is moving the label inside the plot so that I can copy it from paint, otherwise it is cut outside the image
#title(ylab="Backscattered Coefficient (DB)", mgp=c(-2.5,1,0), cex.lab=3)

# draw vertical lines for Novembers
abline(v=2,col="gray",lwd = 1.6)
abline(v=14,col="gray",lwd = 1.6)
abline(v=26,col="gray",lwd = 1.6)
abline(v=38,col="gray",lwd = 1.6)
abline(v=50,col="gray",lwd = 1.6)
abline(v=62,col="gray",lwd = 1.6)
abline(v=74,col="gray",lwd = 1.6)

# draw vertical dotted lines for Julies
# abline(v=7,col="gray",type="l",lty=3)
# abline(v=19,col="gray",type="l",lty=3)
# abline(v=31,col="gray",type="l",lty=3)
# abline(v=43,col="gray",type="l",lty=3)
# abline(v=55,col="gray",type="l",lty=3)
# abline(v=67,col="gray",type="l",lty=3)


# Draw polygon and segments of std deviation trend
polygon(c(sds_X,rev(sds_X)),c(sds_L,rev(sds_H)),col="papayawhip",border="papayawhip")
segments(sds_X, sds_L, sds_X, sds_H, col="orange", lwd=9,)
abline(v=50,col="gray",lwd = 5)
#Draw line connecting points of backscattered coefficients and redraw points of backcoe
lines(x,A,col="black",lwd = 3.6)
points(x,A,lwd = 3)

# add trend of the standard deviation to the graph
abline(regPeaks25L,col="green",lwd = 3.7)
# add trend of all points of backscattered coefficients on the graph
#abline(regPeaks15L,col="blue",lwd = 3.7)
# add trend of peak blooming backscattered coefficients on the graph
#abline(regPeaks24L,col="darkgreen",lwd = 3.7)
abline(regMeans25L,col="darkgreen",lwd = 3.7)





# draw points at peak blooming
points(xpeaks,peaks, cex=.8, pch=4, col="green",lwd = 7)

# draw points at mean backcoe of each year
points(xm,ym, cex=.8, pch=3, col="darkgreen",lwd = 7)         



# draw legend table
 op <- par(cex = 2.3) # font size 
legend(x = "bottomright",  legend = c("Summer Peaks", "Annual Means","Trend of Summer Peaks  (y=-0.0042x+0.7924)", "Trend of Annual Means (y=0.0015x+0.4134)", "Normalised VV ", "Standard Deviation of VV",  "November"), lty = c(0,0,1,1,1,1,1 ), pch = c( 7, 5, NA, NA, NA,NA,NA),  col = c("green","darkgreen","green","darkgreen","black","orange","gray"), lwd = c(3.7,3.7, 3.7, 3.7, 3.7,9,1.6))     


dev.off()

# print linear regression of the standard deviation 
# print(regSds) 
# print linear regression of all bascattered coefficients
print(reg) 
# print linear regression of all peak bascattered coefficients
print(regPeaks) 
